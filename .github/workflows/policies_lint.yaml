---
name: Lint Policies

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - "content/**"
  push:
    branches:
      - main
    paths:
      - "content/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Lint cnspec policies and output SARIF
        uses: mondoohq/actions/cnspec-lint@main
        with:
          path: ./content
          output-file: "results.sarif"
      - name: Install jq
        run: sudo apt-get install jq
      - name: Display SARIF file content
        run: cat results.sarif | jq .
      - name: Upload SARIF results file
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
        with:
          sarif_file: results.sarif
      - name: Check SARIF file content
        id: check_sarif
        run: |
          echo "Checking SARIF file content..."
          RESULTS_EMPTY=$(cat results.sarif | jq '.runs[0].results | map(select(.level != "warning" and .level != "note")) | length == 0')
          if [ "$RESULTS_EMPTY" = "true" ]; then
            echo "SARIF file content is as expected. No results found."
          else
            echo "SARIF file contains results, indicating issues were found. Please review the SARIF file content below for more details, or check the 'Security' tab for alerts once the file has been uploaded."
            exit 1
          fi
