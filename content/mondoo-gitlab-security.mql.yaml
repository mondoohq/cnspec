# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1
policies:
  - uid: mondoo-gitlab-security
    name: Mondoo GitLab Security
    version: 1.4.0
    license: BUSL-1.1
    tags:
      mondoo.com/category: security
      mondoo.com/platform: gitlab
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    docs:
      desc: |
        The Mondoo GitLab Security policy offers guidance on establishing minimum recommended security best practices for GitLab groups and projects.

        ### Prerequisites

        Remote scans of GitLab require a [personal access token](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html) with access to the group and projects you plan to scan.

        ### Scan a GitLab group and projects

        Open a terminal and configure an environment variable with your GitLab personal access token:

        ```bash
        export GITLAB_TOKEN=<your personal access token>
        ```

        Run a remote scan of your GitLab group:

        ```bash
        cnspec scan gitlab --group <group_name>
        ```

        ### Scan a single GitLab project

        Open a terminal and configure an environment variable with your GitLab personal access token:

        ```bash
        export GITLAB_TOKEN=<your personal access token>
        ```

        Scan a GitLab group:

        ```bash
        cnspec scan gitlab --group <group_name> --project <project_name>
        ```

        ## Join the community!

        Our goal is to build policies that are simple to deploy, accurate, and actionable.

        If you have any suggestions for how to improve this policy, or if you need support, [join the community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions."
    groups:
      - title: GitLab Group
        filters: asset.platform == "gitlab" || asset.platform == "gitlab-group"
        checks:
          - uid: mondoo-gitlab-security-private-group
          - uid: mondoo-gitlab-security-private-projects
          - uid: mondoo-gitlab-security-require-two-factor
      - title: GitLab Project
        filters: asset.platform == "gitlab-project"
        checks:
          - uid: mondoo-gitlab-security-private-project
queries:
  - uid: mondoo-gitlab-security-private-group
    title: Ensure the group is private
    mql: |
      gitlab.group.visibility != "public"
    docs:
      desc: |
        GitLab allows users with the Owner role to set a group's visibility as:

        - Public
        - Internal
        - Private

        These visibility levels affect who can see the project in the public access directory (/public for your GitLab instance). For example, https://gitlab.com/public. You can control the visibility of individual features with project feature settings.

        Private projects can only be cloned and viewed by project members (except for guests). They appear in the public access directory (`/public``) for project members only.
      remediation:
        - id: gitlab
          desc: |
            **Using GitLab UI**

            To make the visibility of a GitLab group private:

            1. In GitLab, navigate to your group.
            2. Go to **Settings** > **General**.
            3. Expand the **Visibility, project features, permissions** section.
            4. Under **Visibility level**, select **Private**.
            5. Click **Save changes**.

            For more details, see [Change group visibility](https://docs.gitlab.com/ee/user/public_access.html#change-group-visibility).
        - id: terraform
          desc: |
            **Using Terraform**

            To make the visibility of a GitLab group private using Terraform, you can use the following configuration:

            ```hcl
            resource "gitlab_group" "example" {
              name        = "example"
              path        = "example"
              visibility  = "private"
            }
            ```

            For more details, see the Terraform [GitLab Provider](https://registry.terraform.io/providers/gitlabhq/gitlab/latest/docs/resources/group).
  - uid: mondoo-gitlab-security-require-two-factor
    title: Ensure two-factor authentication is required
    mql: |
      gitlab.group.requireTwoFactorAuthentication == true
    docs:
      desc: |
        Two-factor authentication (2FA) provides an additional layer of security to your users' GitLab accounts. When enabled, users are prompted for a code generated by an application in addition to supplying their username and password to sign in.
      remediation:
        - id: gitlab
          desc: |
            **Using GitLab UI**

            To require two-factor authentication for all users in a GitLab group:

            1. In GitLab, navigate to your group.
            2. Go to **Settings** > **General**.
            3. Expand the **Permissions and group features** section.
            4. Under **Require two-factor authentication**, check the box.
            5. Click **Save changes**.

            For more details, see [Enforce two-factor authentication](https://docs.gitlab.com/ee/security/two_factor_authentication.html).
        - id: terraform
          desc: |
            **Using Terraform**

            To require two-factor authentication for all users in a GitLab group using Terraform, you can use the following configuration:

            ```hcl
            resource "gitlab_group" "example" {
              name        = "example"
              path        = "example"
              require_two_factor_authentication = true
            }
            ```

            For more details, see the Terraform [GitLab Provider](https://registry.terraform.io/providers/gitlabhq/gitlab/latest/docs/resources/group).
  - uid: mondoo-gitlab-security-private-projects
    title: Ensure all projects are private
    mql: gitlab.group.projects.none( visibility == "public")
    docs:
      desc: |
        GitLab allows users with the Owner role to set a project's visibility as:

        - Public
        - Internal
        - Private

        These visibility levels affect who can see the project in the public access directory (/public for your GitLab instance). For example, https://gitlab.com/public. You can control the visibility of individual features with project feature settings.

        Private projects can only be cloned and viewed by project members (except for guests). They appear in the public access directory (`/public``) for project members only.
      remediation:
        - id: gitlab
          desc: |
            **Using GitLab UI**

            To make all projects in a GitLab group private:

            1. In GitLab, navigate to your group.
            2. Go to **Settings** > **General**.
            3. Expand the **Visibility, project features, permissions** section.
            4. Under **Default project visibility**, select **Private**.
            5. Click **Save changes**.

            For more details, see [Change group visibility](https://docs.gitlab.com/ee/user/public_access.html#change-group-visibility).
        - id: terraform
          desc: |
            **Using Terraform**

            To make all projects in a GitLab group private using Terraform, you can use the following configuration:

            ```hcl
            resource "gitlab_group" "example" {
              name        = "example"
              path        = "example"
              visibility  = "private"
            }
            ```

            For more details, see the Terraform [GitLab Provider](https://registry.terraform.io/providers/gitlabhq/gitlab/latest/docs/resources/group).
  - uid: mondoo-gitlab-security-private-project
    title: Ensure the project is private
    mql: gitlab.project.visibility != "public"
    docs:
      desc: |
        GitLab allows users with the Owner role to set an individual project's visibility as:

        - Public
        - Internal
        - Private

        These visibility levels affect who can see the project in the public access directory (/public for your GitLab instance). For example, https://gitlab.com/public. You can control the visibility of individual features with project feature settings.

        Private projects can only be cloned and viewed by project members (except for guests). They appear in the public access directory (`/public``) for project members only.
      remediation:
        - id: gitlab
          desc: |
            **Using GitLab UI**

            To make the visibility of an individual GitLab project private:

            1. In GitLab, navigate to your project.
            2. Go to **Settings** > **General**.
            3. Expand the **Visibility, project features, permissions** section.
            4. Under **Project visibility**, select **Private**.
            5. Click **Save changes**.

            For more details, see [Change project visibility](https://docs.gitlab.com/ee/user/public_access.html#change-project-visibility).
        - id: terraform
          desc: |
            **Using Terraform**

            To make an individual GitLab project private using Terraform, you can use the following configuration:

            ```hcl
            resource "gitlab_project" "example" {
              name         = "example"
              path         = "example"
              visibility   = "private"
              namespace_id = gitlab_group.example.id
            }
            ```

            For more details, see the Terraform [GitLab Provider](https://registry.terraform.io/providers/gitlabhq/gitlab/latest/docs/resources/project).
