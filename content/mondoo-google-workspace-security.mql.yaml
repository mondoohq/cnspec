# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1
policies:
  - uid: mondoo-google-workspace-security
    name: Mondoo Google Workspace Security
    version: 1.0.0
    license: BUSL-1.1
    tags:
      mondoo.com/category: security
      mondoo.com/platform: google-workspace,saas
    require:
      - provider: google-workspace
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    docs:
      desc: |
        The Mondoo Google Workspace Security policy identifies misconfigurations that could expose your organization to account takeover, data breaches, and unauthorized access. Google Workspace serves as the productivity and collaboration hub for many organizations, and misconfigurations can enable attackers to access email, documents, and corporate data across connected services.

        This policy validates critical security controls including authentication settings, app access restrictions, sharing policies, and administrative configurations.

        ### Prerequisites

        1. Create/Select a GCP project
        2. Navigate to the [Google API Console](https://console.cloud.google.com/apis/dashboard).
        3. Select "Enable APIs and Services" and enable the following APIs:
          - Admin SDK API
          - Cloud Identity API
          - Google Calendar API
          - Google Drive API
          - Gmail API
          - Google People API
        4. Create a service account for [Google Workspace](https://support.google.com/a/answer/7378726?product_name=UnuFlow&hl=en&visit_id=638041387835615758-4147680582&rd=1&src=supportwidget0&hl=en)
        5. Create credentials for the service account and download the json file
        6. Enter the following scopes in Security -> Access and data controls -> API controls, and select [Domain-wide Delegation](https://developers.google.com/workspace/guides/create-credentials#delegate_domain-wide_authority_to_your_service_account)

          - https://www.googleapis.com/auth/admin.chrome.printers.readonly
          - https://www.googleapis.com/auth/admin.directory.customer.readonly
          - https://www.googleapis.com/auth/admin.directory.device.chromeos.readonly
          - https://www.googleapis.com/auth/admin.directory.device.mobile.readonly
          - https://www.googleapis.com/auth/admin.directory.domain.readonly
          - https://www.googleapis.com/auth/admin.directory.group.member.readonly
          - https://www.googleapis.com/auth/admin.directory.group.readonly
          - https://www.googleapis.com/auth/admin.directory.orgunit.readonly
          - https://www.googleapis.com/auth/admin.directory.resource.calendar.readonly
          - https://www.googleapis.com/auth/admin.directory.rolemanagement.readonly
          - https://www.googleapis.com/auth/admin.directory.user.alias.readonly
          - https://www.googleapis.com/auth/admin.directory.user.readonly
          - https://www.googleapis.com/auth/admin.directory.userschema.readonly
          - https://www.googleapis.com/auth/admin.reports.audit.readonly
          - https://www.googleapis.com/auth/admin.reports.usage.readonly
          - https://www.googleapis.com/auth/admin.directory.user.security
          - https://www.googleapis.com/auth/cloud-identity.groups.readonly

        ### Run policy

        To run this policy against a Google Workspace customer:

        ```bash
        export GOOGLEWORKSPACE_CREDENTIALS=$PWD/my-project-123456-1234ea722b12.json
        cnspec scan google-workspace --customer-id <CUSTOMERID> --impersonated-user-email <EMAIL>
        ```

        ## Join the community!

        Our goal is to build policies that are simple to deploy, accurate, and actionable.

        If you have any suggestions for how to improve this policy, or if you need support, [join the community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions.
    groups:
      - filters: asset.platform == "google-workspace"
        checks:
          - uid: mondoo-googleworkspace-security-less-secure-app-access-should-not-be-allowed
          - uid: mondoo-googleworkspace-security-limit-super-admins
          - uid: mondoo-googleworkspace-security-minimum-super-admins
          - uid: mondoo-googleworkspace-security-super-admins-should-use-hardware-based-2fa
          - uid: mondoo-googleworkspace-security-two-step-verification-enforced
queries:
  - uid: mondoo-googleworkspace-security-two-step-verification-enforced
    title: Ensure 2-step verification (multi-factor authentication) is enforced for all users
    impact: 60
    mql: googleworkspace.users.all ( isEnforcedIn2Sv == true )
    docs:
      desc: |
        This check verifies that 2-step verification (multi-factor authentication) is enforced for all Google Workspace users in your organization.

        **Why this matters**

        Multi-factor authentication is critical for protecting cloud-based productivity services that contain sensitive organizational data:

          - **Account takeover prevention**: Even if passwords are stolen through phishing or breaches, attackers cannot access accounts without the second factor.
          - **Credential stuffing defense**: Reused passwords from other compromised services cannot be used to access Google Workspace.
          - **Compliance requirements**: SOC 2, ISO 27001, HIPAA, and other frameworks require or recommend MFA for all users.
          - **Lateral movement prevention**: Compromised accounts cannot be used to access shared documents, email, or connected services.
          - **Business email compromise**: BEC attacks often begin with account takeover, which MFA helps prevent.

        Enforce 2-step verification at the organizational level to ensure consistent protection across all user accounts.
      remediation:
        - id: console
          desc: |
            To enable 2-Step Verification (2FA) for Google Workspace users:

            1. Sign in to the [Google Admin console](https://admin.google.com/) using your administrator account.
            2. From the Admin console Home page, go to **Security** > **Authentication** > **2-step verification**.
            3. Click **Allow users to turn on 2-step verification** and select **On**.
            4. (Recommended) To enforce 2-step verification, under **Enforcement**, select **Turn on enforcement now** or **Turn on enforcement from** and choose a date.
            5. Click **Save**.
            6. Inform your users to set up 2-step verification the next time they sign in.

            For more details, see [Enforce 2-Step Verification](https://support.google.com/a/answer/175197?hl=en).
  - uid: mondoo-googleworkspace-security-limit-super-admins
    title: Ensure fewer than four users have super admin permissions
    impact: 60
    mql: googleworkspace.report.users.where(security["isSuperAdmin"] == true).length <= 4
    docs:
      desc: |
        This check verifies that your Google Workspace organization has no more than 4 users with super admin permissions.

        **Why this matters**

        Super admin accounts have unrestricted access to all organizational data and settings, making them high-value targets:

          - **Attack surface expansion**: Each super admin account increases the number of potential compromise vectors for attackers.
          - **Privilege accumulation**: Organizations often accumulate super admins over time without removing former ones.
          - **Audit complexity**: Too many super admins makes it difficult to track who made security-sensitive changes.
          - **Compliance concerns**: Security frameworks recommend minimizing the number of highly privileged accounts.
          - **Blast radius**: A compromised super admin can access all organizational data, users, and settings.

        Limit super admin accounts to essential personnel and use delegated admin roles for users who need limited administrative access.
      remediation: |
        Adjust the number of users who have admin privileges to be between 2 and 4. To learn how, read [Admin roles for businesses](https://support.google.com/a/topic/9832445?hl=en&ref_topic=2785005) in the Google Workspace documentation.
  - uid: mondoo-googleworkspace-security-minimum-super-admins
    title: Ensure more than one user has super admin permissions
    impact: 60
    mql: googleworkspace.report.users.where(security["isSuperAdmin"] == true).length > 1
    docs:
      desc: |
        This check verifies that your Google Workspace organization has more than one user with super admin permissions.

        **Why this matters**

        Having only one super admin creates operational and security risks for your organization:

          - **Single point of failure**: If the sole super admin is unavailable, the organization cannot perform critical administrative tasks.
          - **Account lockout risk**: If the single admin account is compromised or locked, there is no way to regain administrative access.
          - **Emergency response**: Security incidents may require immediate administrative action that is impossible with an unavailable admin.
          - **Business continuity**: Extended admin unavailability can disrupt onboarding, offboarding, and security operations.
          - **Recovery complexity**: Google's account recovery process for organizations with a single locked admin is complex and time-consuming.

        Maintain at least 2 super admin accounts held by trusted individuals to ensure administrative access is always available.
      remediation: |
        Adjust the number of users who have admin privileges to be between 2 and 4. To learn how, read [Admin roles for businesses](https://support.google.com/a/topic/9832445?hl=en&ref_topic=2785005) in the Google Workspace documentation.
  - uid: mondoo-googleworkspace-security-less-secure-app-access-should-not-be-allowed
    title: Users should not be allowed less secure app access
    impact: 70
    mql: googleworkspace.report.users.all(security["isLessSecureAppsAccessAllowed"] == false)
    docs:
      desc: |
        This check verifies that users are not allowed to grant access to "less secure apps" that use legacy authentication methods without OAuth.

        **Why this matters**

        Less secure apps bypass modern authentication security controls, creating significant vulnerability:

          - **No OAuth protection**: These apps require storing raw passwords instead of using secure token-based authentication.
          - **MFA bypass**: Less secure apps often cannot support multi-factor authentication, negating your 2FA enforcement.
          - **Credential exposure**: Stored passwords in less secure apps can be extracted if those apps or devices are compromised.
          - **Limited visibility**: Legacy authentication methods provide less logging and monitoring capability.
          - **Attack vector**: Threat actors specifically target less secure app access as a way to bypass MFA requirements.

        Block less secure app access organization-wide and migrate users to applications that support modern OAuth authentication.
      remediation: |
        Make sure to block the usage of less secure apps in Google Workspace. To learn how, read [Control access to less secure apps](https://support.google.com/a/answer/6260879?hl=en) in the Google Workspace documentation.
  - uid: mondoo-googleworkspace-security-super-admins-should-use-hardware-based-2fa
    title: Super users should use hardware-based security keys
    impact: 70
    mql: googleworkspace.report.users.where(security["isSuperAdmin"] == true).all(security["numSecurityKeys"] >= 1)
    docs:
      desc: |
        This check verifies that all super admin accounts have at least one hardware security key registered for 2-step verification.

        **Why this matters**

        Super admin accounts have complete control over the organization and require the strongest possible authentication protection:

          - **Phishing immunity**: Hardware security keys are resistant to phishing attacks because they verify the legitimate site origin.
          - **SIM swapping protection**: Unlike SMS, security keys cannot be compromised through carrier social engineering.
          - **FIDO2/WebAuthn standard**: Modern security keys use cryptographic protocols that prevent credential interception.
          - **Compliance requirements**: Many security frameworks recommend hardware tokens for privileged account protection.
          - **High-value target**: Super admins can access all organizational data, making them priority targets for sophisticated attackers.

        Require all super admin accounts to use FIDO2-compliant hardware security keys (such as YubiKey or Google Titan) for 2-step verification.
      remediation: |
        Make sure that all high-value targets such as Super Admins have some form of two-factor authentication enabled. Also make sure that they are using security keys for the 2-Step verification process. To learn about setting up security keys for the 2-Step verification process, read [Use a security key for 2-Step Verification](https://support.google.com/accounts/answer/6103523?hl=En).
