# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1
policies:
  - uid: mondoo-microsoft-vulnerability
    name: Mondoo Microsoft Vulnerability
    version: 1.1.0
    license: BUSL-1.1
    tags:
      mondoo.com/category: security
      mondoo.com/platform: windows
    require:
      - provider: os
    authors:
      - name: Mondoo, Inc.
        email: hello@mondoo.com
    docs:
      desc: |
        The Mondoo Microsoft Vulnerability policy checks for Windows and Microsoft Application vulnerabilities. It should be used in combination with the Platform Vulnerability Policy to identify missing patches.

        ### Run policy

        To run this policy against a Windows system:

        ```bash
        cnspec scan ssh user@domain.local@192.168.1.1 --ask-pass -f core/mondoo-microsoft-vulnerability.mql.yaml
        ```

        Have suggestions for new checks in this policy? Visit our [cnspec repository](https://github.com/mondoohq/cnspec).
    groups:
      - title: Windows Office 2016, 2019, 2021
        filters: |
          asset.platform == "windows"
          packages.where( name == /Office/ && name == /2016|2019|2021/ ).length > 0
        checks:
          - uid: mondoo-microsoft-vulnerability-office-CVE-2023-21716
      - title: Windows Office
        filters: |
          asset.platform == "windows"
          packages.where( name == /Office/ && name == /2016|2019|2021/ ).all(version.split('.')[0] == 16 && version.split('.')[2] < 16026)
        checks:
          - uid: mondoo-microsoft-vulnerability-office-CVE-2023-21716-workaround
      - title: Windows SharePoint
        filters: |
          asset.platform == "windows"
          packages.where( name == /SharePoint/ ).length > 0
        checks:
          - uid: mondoo-microsoft-vulnerability-sharepoint-CVE-2023-21716
queries:
  - uid: mondoo-microsoft-vulnerability-office-CVE-2023-21716
    title: Ensure Microsoft Word Remote Code Execution Vulnerability for Office is not on the system
    impact: 98
    mql: |
      packages.where( name == /Office/ && name == /2016|2019|2021/ ).all(version.split('.')[0] == 16 && version.split('.')[2] >= 16026)
    docs:
      desc: |
        The critical vulnerability CVE-2023-21716 is a Microsoft Word RTF Font Table Heap Corruption and allows attackers to achieve remote code execution with the victim's privileges that opens a malicious RTF document. More information can be found at [https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md](https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md)
      remediation:
        - id: console
          desc: |
            Please update your Office installation or use the workaround. More information can be found at [https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716).
        - id: powershell
          desc: |
            **Using PowerShell to check Office version**

            ```powershell
            # Update Office via command line
            # For Click-to-Run installations:
            "C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeC2RClient.exe" /update user
            ```
        - id: ansible
          desc: |
            **Using Ansible**

            ```yaml
            - name: Update Microsoft Office
              hosts: windows
              tasks:
                - name: Trigger Office Click-to-Run update
                  ansible.windows.win_command: >
                    "C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeC2RClient.exe" /update user
                  ignore_errors: true
            ```
    refs:
      - url: https://learn.microsoft.com/en-us/officeupdates/microsoft365-apps-security-updates
        title: Release notes for Microsoft Office security updates
  - uid: mondoo-microsoft-vulnerability-office-CVE-2023-21716-workaround
    title: Block opening RTF documents (workaround)
    impact: 98
    mql: |
      registrykey.property(path: 'HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\Word\Security\FileBlock', name: 'RtfFiles').value == 2 || registrykey.property(path: 'HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Word\Security\FileBlock', name: 'RtfFiles').value == 2
      registrykey.property(path: 'HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\Word\Security\FileBlock', name: 'OpenInProtectedView').value == 0 || registrykey.property(path: 'HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Word\Security\FileBlock', name: 'OpenInProtectedView').value == 0
    docs:
      desc: |
        The critical vulnerability CVE-2023-21716 is a Microsoft Word RTF Font Table Heap Corruption and allows attackers to achieve remote code execution with the victim's privileges that opens a malicious RTF document. More information can be found at [https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md](https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md)

        Use Microsoft Office File Block policy to prevent Office from opening RTF documents from unknown or untrusted sources.

        Impact of workaround: Email messages viewed in plain text format will not contain pictures, specialized fonts, animations, or other rich content. In addition, the following behavior may be experienced:

          - The changes are applied to the preview pane and to open messages.
          - Pictures become attachments so that they are not lost.
          - Because the message is still in Rich Text or HTML format in the store, the object model (custom code solutions) may behave unexpectedly.
      remediation:
        - id: console
          desc: |
            **For Office 2013**

            Run regedit.exe as Administrator and navigate to the following subkey:

              `[HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\Word\Security\FileBlock]`

              Set the RtfFiles DWORD value to 2.

              Set the OpenInProtectedView DWORD value to 0.

            **For Office 2016/ 2019/ 2021**

            Run regedit.exe as Administrator and navigate to the following subkey:

              `[HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Word\Security\FileBlock]`

              Set the RtfFiles DWORD value to 2.

              Set the OpenInProtectedView DWORD value to 0.
        - id: powershell
          desc: |
            **Using PowerShell**

            ```powershell
            # For Office 2013
            $path15 = "HKCU:\Software\Microsoft\Office\15.0\Word\Security\FileBlock"
            if (!(Test-Path $path15)) { New-Item -Path $path15 -Force }
            Set-ItemProperty -Path $path15 -Name "RtfFiles" -Value 2 -Type DWord
            Set-ItemProperty -Path $path15 -Name "OpenInProtectedView" -Value 0 -Type DWord

            # For Office 2016/2019/2021
            $path16 = "HKCU:\Software\Microsoft\Office\16.0\Word\Security\FileBlock"
            if (!(Test-Path $path16)) { New-Item -Path $path16 -Force }
            Set-ItemProperty -Path $path16 -Name "RtfFiles" -Value 2 -Type DWord
            Set-ItemProperty -Path $path16 -Name "OpenInProtectedView" -Value 0 -Type DWord
            ```
        - id: ansible
          desc: |
            **Using Ansible**

            ```yaml
            - name: Apply CVE-2023-21716 RTF workaround
              hosts: windows
              tasks:
                - name: Apply workaround for Office 2013
                  ansible.windows.win_regedit:
                    path: HKCU:\Software\Microsoft\Office\15.0\Word\Security\FileBlock
                    name: "{{ item.name }}"
                    data: "{{ item.value }}"
                    type: dword
                  loop:
                    - { name: 'RtfFiles', value: 2 }
                    - { name: 'OpenInProtectedView', value: 0 }

                - name: Apply workaround for Office 2016/2019/2021
                  ansible.windows.win_regedit:
                    path: HKCU:\Software\Microsoft\Office\16.0\Word\Security\FileBlock
                    name: "{{ item.name }}"
                    data: "{{ item.value }}"
                    type: dword
                  loop:
                    - { name: 'RtfFiles', value: 2 }
                    - { name: 'OpenInProtectedView', value: 0 }
            ```
    refs:
      - url: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716
        title: Microsoft Word Remote Code Execution Vulnerability
  - uid: mondoo-microsoft-vulnerability-sharepoint-CVE-2023-21716
    title: Ensure Microsoft Word Remote Code Execution Vulnerability for SharePoint is not on the system
    impact: 98
    mql: |
      packages.where( name == /SharePoint/ && name == /2016/ ).all(version.split('.')[0] == 15 && version.split('.')[2] >= 5529)
      packages.where( name == /SharePoint/ && name == /2016/ ).all(version.split('.')[0] == 16 && version.split('.')[2] >= 5383)
      packages.where( name == /SharePoint/ && name == /2019/ ).all(version.split('.')[0] == 16 && version.split('.')[2] >= 10395)
    docs:
      desc: |
        The critical vulnerability CVE-2023-21716 is a Microsoft Word RTF Font Table Heap Corruption and allows attackers to achieve remote code execution with the victim's privileges that opens a malicious RTF document. More information can be found at [https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md](https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md)
      remediation:
        - id: console
          desc: |
            Please update your SharePoint installation. More information can be found at [https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716)
        - id: powershell
          desc: |
            **Using PowerShell**

            ```powershell
            # Check current SharePoint version
            Get-SPFarm | Select BuildVersion

            # Download and install the appropriate security update from Microsoft Update Catalog
            # For SharePoint 2013: KB5002347
            # For SharePoint 2016: KB5002325
            # For SharePoint 2019: KB5002342

            # After downloading the update, install using:
            # psconfig.exe -cmd upgrade -inplace b2b -wait -force
            ```
        - id: ansible
          desc: |
            **Using Ansible**

            ```yaml
            - name: Update SharePoint Server
              hosts: sharepoint_servers
              tasks:
                - name: Download SharePoint security update
                  ansible.windows.win_get_url:
                    url: "{{ sharepoint_update_url }}"
                    dest: "C:\\Updates\\sharepoint_update.exe"

                - name: Install SharePoint security update
                  ansible.windows.win_package:
                    path: "C:\\Updates\\sharepoint_update.exe"
                    arguments: /quiet /norestart
                    state: present
                  register: update_result

                - name: Run PSConfig to complete upgrade
                  ansible.windows.win_command: >
                    psconfig.exe -cmd upgrade -inplace b2b -wait -force
                  when: update_result.changed
            ```
    refs:
      - url: https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-sharepoint-foundation-2013-february-14-2023-kb5002347-4c58e863-2d2f-440e-b0cd-f4f8fb4bcba6
        title: Description of the security update for SharePoint Foundation 2013 February 14, 2023 (KB5002347)
      - url: https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-sharepoint-enterprise-server-2016-language-pack-february-14-2023-kb5002325-c5c23c76-63e8-482b-ad36-4d0a999454cb
        title: Description of the security update for SharePoint Enterprise Server 2016 Language Pack February 14, 2023 (KB5002325)
      - url: https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-sharepoint-server-2019-february-14-2023-kb5002342-abd83b9f-b088-44fb-a583-f45337d83cba
        title: Description of the security update for SharePoint Server 2019 February 14, 2023 (KB5002342)
