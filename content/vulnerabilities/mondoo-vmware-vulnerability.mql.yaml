# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1
policies:
  - uid: mondoo-vmware-vulnerability
    name: Mondoo VMware vCenter Vulnerability
    version: 1.1.0
    license: BUSL-1.1
    tags:
      mondoo.com/category: security
      mondoo.com/platform: vmware,vmware-esxi
    require:
      - provider: vsphere
    authors:
      - name: Mondoo, Inc.
        email: hello@mondoo.com
    summary: Detect vCenter and ESXi vulnerabilities
    docs:
      desc: |
        The Mondoo VMware vCenter policy checks for vulnerable vCenter/ESXi configuration. It should be used in combination with the Platform Vulnerability Policy to identify missing patches.

        ### Run policy

        To run this policy against VMware vCenter:

        ```bash
        cnspec scan vsphere user@domain.local@192.168.5.24 --ask-pass -f core/mondoo-vmware-vulnerability.mql.yaml
        ```

        Have suggestions for new checks in this policy? Visit our [cnspec repository](https://github.com/mondoohq/cnspec).
    groups:
      - title: VMware ESXi
        filters: asset.platform == "vmware-esxi"
        checks:
          - uid: mondoo-vmware-vulnerability-slpd-not-running
queries:
  - uid: mondoo-vmware-vulnerability-slpd-not-running
    title: Ensure the slpd service is not running
    mql: vsphere.host.services.none(key == "slpd" && running == true)
    docs:
      desc: |
        In 2021, ESXi 7.0 U2c and ESXi 8.0 GA began shipping with the service disabled by default.
      remediation:
        - id: cli
          desc: |
            **Using CLI**

            To disable the slpd service, run the following command on the ESXi host:

            ```bash
            esxcli system slp set --enable false
            ```
    refs:
      - url: https://blogs.vmware.com/security/2023/02/83330.html
        title: VMware Security Response Center (vSRC) Response to 'ESXiArgs' Ransomware Attacks
      - url: https://support.broadcom.com/web/ecx/support-content-notification/-/external/content/SecurityAdvisories/0/23599
        title: VMSA-2021-0002
      - url: https://knowledge.broadcom.com/external/article?legacyId=76372
        title: How to Disable/Enable the SLP Service on VMware ESXi (76372)
